## Official Code of Table Tennis Coaching System Based on a Multimodal Large Language Model with a Table Tennis Knowledge Base

### 配置环境

本项目依赖于 `conda` 环境管理工具来确保依赖包的版本一致性和兼容性。请按照以下步骤来配置和激活项目环境。

#### 1. 安装 `conda`

如果您尚未安装 `conda`，请访问 [Anaconda 官网](https://www.anaconda.com/) 或 [Miniconda 官网](https://docs.conda.io/en/latest/miniconda.html) 获取安装指南，并根据您的操作系统完成安装。

#### 2. 准备 `env.yaml` 文件

确保项目根目录下已经存在一个名为 `env.yaml` 的环境配置文件。该文件定义了项目所需的所有依赖包及其版本信息。

#### 3. 创建并配置环境

使用以下命令，根据 `env.yaml` 文件创建新的 conda 环境：

```bash
conda env create -f env.yaml
```

此命令将根据 `env.yaml` 中列出的依赖包安装对应的版本，并创建一个新的 conda 环境。

#### 4. 激活环境

创建完成后，可以通过以下命令激活该环境：

```bash
conda activate tt-llm
```

激活后，终端的提示符会显示当前环境名称，表示环境已成功激活。

#### 5. 验证环境

要确保环境已经正确配置并激活，可以使用以下命令查看当前的 conda 环境：

```bash
conda info --envs
```

激活环境后，项目的所有依赖包都应该已经可用，您现在可以开始使用项目中的代码。

### 1_init_video ：视频帧浏览与剪辑工具

#### 简介

该脚本用于逐帧浏览视频，并根据用户选择的起点和终点剪辑视频片段。

#### 使用方法

在终端中运行以下命令：

```bash
python 1_init_video.py --vpath <视频路径> --name <输出名称>
```

- `<视频路径>`: 视频文件的路径。
- `<输出名称>`: 剪辑后视频的名称前缀。

#### 键盘操作

- `1/2`: 前进/后退 1 帧
- `3/4`: 前进/后退 4 帧
- `5/6`: 前进/后退 30 帧
- `s`: 保存当前帧为起点
- `e`: 保存当前帧为终点
- `n`: 显示当前帧号
- `ESC`: 退出并保存视频剪辑

剪辑片段将以 `<输出名称>_编号.avi` 格式保存。

### 2_openpose.ps1 脚本 - 使用说明

#### 目的：

此 PowerShell 脚本用于自动处理 `.avi` 格式的视频文件，并使用 OpenPose 提取人体姿态估计结果，将结果以 JSON 格式输出到指定的目录中。

#### 前提条件：

- 已安装 OpenPose，且 `OpenPoseDemo.exe` 位于 `bin` 文件夹下。
- 需要处理的 `.avi` 文件存放在指定的数据目录中。

#### 主要变量：

- `$openPoseDemoPath`: OpenPose 可执行文件（`OpenPoseDemo.exe`）的路径。
- `$dataDir`: 存放 `.avi` 视频文件的目录路径（如 `C:\project\data`）。

#### 脚本执行步骤：

1. **设置编码：** 设置为使用 UTF-8 编码，以确保控制台输出的正确处理。

2. **切换目录到 OpenPose：** 脚本会导航到 `openpose` 目录，在该目录下执行 OpenPose 的相关操作。

3. **处理每个 `.avi` 文件：**
   
   - 扫描指定的目录 `$dataDir` 中的 `.avi` 文件。
   - 对于找到的每个视频文件：
     - 在数据目录下创建一个以该文件名命名的子目录（去掉扩展名）。
     - 使用 OpenPose 的 `--video` 参数处理视频，并将姿态估计结果以 JSON 格式输出到刚创建的子目录中。
     - 为了加快处理速度，禁用了 OpenPose 的显示和渲染功能（`--display 0 --render_pose 0`）。
     - 每处理完一个视频文件后，脚本暂停 60 秒，再处理下一个视频。

4. **完成提示：** 当所有视频文件处理完毕后，脚本会显示 "all ok"。

#### 如何运行：

1. 确保需要处理的视频文件都放在 `$dataDir` 路径下（如 `C:\project\data`）。

2. 打开 PowerShell，导航到存放脚本（`2_openpose.ps1`）的目录。

3. 运行以下命令启动脚本：
   
   ```ps
   .\2_openpose.ps1
   ```

4. 每个视频文件的处理结果将存放在 `$dataDir` 内的子目录中，每个子目录的名称对应于相应的视频文件名。

#### 自定义：

- **更改数据目录：** 可以修改 `$dataDir` 变量以指向包含你的 `.avi` 文件的目录。
- **调整 OpenPose 参数：** 可以在 `$openPoseCommand` 中添加或修改 OpenPose 的选项，以自定义姿态估计的输出结果。

### 3_action_recognition - 使用说明

脚本 `3_action_recognition.py` 用于处理视频帧，分析人体的关键点数据，提取动作特征，并绘制各种动作相关的图像输出。代码功能分为几个主要步骤：

#### 参数

脚本通过命令行传入两个参数：

- `--vpath`: 视频文件的路径（字符串类型）
- `--fpath`: 包含JSON文件的文件夹路径（字符串类型）

示例运行：

```bash
python 3_action_recognition.py --vpath "/path/to/video.mp4" --fpath "/path/to/json/folder"
```

#### 功能说明

1. **`get_output_path(input_path)`**  
   生成处理视频的输出文件路径。

2. **`find_people(folder_path)`**  
   从指定的文件夹中读取 JSON 文件，解析其中人体姿态的关键点数据，绘制身体关键点，并让用户选择需要处理的某个人。

3. **`openpose_data_get(folder_path, right_shoulder_select)`**  
   通过遍历文件夹内的 JSON 文件，计算每一帧中与选择的人物关键点最接近的人的关键点数据。

4. **`calculate_angle(p1, p2, p3)`**  
   计算由三个点（如肩、肘、腕）构成的角度。

5. **`triangle_centroid(point1, point2, point3)`**  
   计算由三个点构成的三角形的重心。

6. **`calculate_s_angle(r_shoulder, l_shoulder)`**  
   计算两个点（如左右肩）之间的斜率角度。

7. **绘制与计算图像**  
   
   - 脚本会分析动作角度、距离等，生成并保存图像如手臂角度变化、肩部移动、重心变化等。
   - 各个图像会保存在指定文件夹内，如 `arm_vector.jpg`, `arm_angle.jpg`, `bcx.jpg`, `bcy.jpg` 等。

8. **视频帧截取**  
   脚本会根据分析结果从视频中截取某一帧，并根据计算的关键点位置对图像进行裁剪保存。裁剪图像文件如 `paddle.jpg`, `people.jpg` 会保存到指定文件夹。

#### 输出

脚本会在指定文件夹中输出多张分析结果图像以及动作特征分析后的视频帧截取图像。

### 4_table_tennis_trace.py - 使用说明

#### 功能描述

该脚本用于从视频中检测并跟踪物体轨迹，特别适用于如乒乓球运动的轨迹检测。脚本通过背景减除、斑点检测等图像处理技术，提取物体轨迹并可视化输出。

#### 命令行参数

脚本支持通过命令行传递视频文件和输出文件夹路径。

- `--vpath` : 视频文件路径
- `--fpath` : 输出文件夹路径

#### 使用方法

运行脚本时，需提供视频文件的路径和输出文件夹路径：

```bash
python 4_table_tennis_trace.py --vpath /path/to/video.mp4 --fpath /path/to/output_folder
```

例如：

```bash
python 4_table_tennis_trace.py --vpath ./videos/sample.mp4 --fpath ./output
```

#### 工作流程

1. **读取视频**：使用 OpenCV 打开视频文件，读取帧的尺寸并初始化背景减除器。
2. **背景减除**：对视频逐帧进行背景减除，生成掩膜图像，进行高斯模糊处理，并将处理后的帧保存为新的视频文件。
3. **斑点检测**：通过 `blob_log` 方法检测视频中的物体轨迹，主要使用了 Otsu 阈值分割与连通区域标记来提取物体形状和位置。
4. **轨迹可视化**：在处理完所有帧后，脚本生成物体运动轨迹的散点图，标注每个点的索引，并提供颜色渐变以指示运动时间。
5. **用户交互**：
   - 用户可通过输入起始点和结束点，截取特定范围内的轨迹数据进行绘制。
   - 用户可以选择保留的轨迹点，生成并保存最终的轨迹图像。

#### 输出

- 处理后的视频文件（掩膜视频）：在输入视频所在目录下生成文件名带有 `_mask` 的视频。
- 轨迹图像：处理完轨迹后，轨迹图保存为 `pptrace.jpg`，存储在提供的 `--fpath` 指定的目录中。

#### 注意事项

- 确保视频文件路径和输出文件夹路径正确。
- 视频处理可能需要较长时间，尤其是视频帧数较多时。

### 5_knowledge_base.py - 使用说明

#### 功能简介

该脚本用于从给定的原始知识库文件中提取问题与答案，通过调用指定的 API 获取问题的文本嵌入，并将这些信息保存为结构化的 CSV 文件，用于后续的知识库查询和管理。

#### 使用步骤

1. **参数说明**：
   运行脚本时需要传递以下参数：
   
   - `--api_key`: 用于访问 API 的密钥。
   - `--base_url`: API 的基础 URL（例如 `api.openai.com`）。
   - `--path_raw_kb`: 原始知识库文件的路径，文件需按特定格式存储问题和答案。
   - `--path_save_kb`: 用于保存生成的知识库文件的路径（CSV 格式）。

2. **文件格式**：
   原始知识库文件应按照如下格式编写：
   
   ```
   Q1: 问题1
   A1: 答案1
   Q2: 问题2
   A2: 答案2
   ...
   ```

3. **运行示例**：
   在终端运行脚本：
   
   ```bash
   python 5_knowledge_base.py --api_key "your_api_key" --base_url "api.openai.com" --path_raw_kb "raw_kb.txt" --path_save_kb "processed_kb.csv"
   ```

4. **脚本工作流程**：
   
   - 读取指定的原始知识库文件，提取问题与答案。
   - 调用指定 API 获取问题的文本嵌入。
   - 将问题、答案及其嵌入向量存储为 CSV 文件，供后续使用。

#### 注意事项

- 请确保 API key 有效，并且能够访问指定的 API 基础 URL。
- 输入的知识库文件需符合格式要求，否则解析可能失败。

### 6_llm_ttcoach.py - 使用说明

该程序通过大语言模型（LLM）提供乒乓教练功能。用户可以输入不同的参数，通过API请求模型，生成个性化的提示，并结合图像进行错误分析。

#### 参数详解

1. **`--api_key`**（字符串，**必填**）
   
   - **描述**：您的 API 密钥，用于验证并授权访问大语言模型的服务。
   - **用途**：程序通过此密钥与 API 进行通信，确保您有权限调用模型。
   - **示例**：`--api_key your_api_key_here`

2. **`--base_url`**（字符串，**必填**）
   
   - **描述**：API 的基础 URL，即服务器的地址。
   - **用途**：指定程序应连接到哪个服务器以访问模型服务。
   - **示例**：`--base_url api.example.com`

3. **`--model`**（字符串，**必填**）
   
   - **描述**：要使用的模型名称。
   - **用途**：选择特定的大语言模型版本，如 `gpt-4-turbo`。
   - **示例**：`--model gpt-4-turbo`

4. **`--fpath`**（字符串，**必填**）
   
   - **描述**：工作文件夹的路径。
   - **用途**：指定程序运行时所需的文件和图像所在的目录。
   - **示例**：`--fpath /path/to/your/workfolder`

5. **`--type`**（整数，取值范围为 **1-8**，**必填**）
   
   - **描述**：错误类型的编号，用于选择要分析的错误类型。
   - **用途**：程序根据此类型调用对应的错误分析函数。
   - **示例**：`--type 3`

6. **`--kb_file`**（字符串，**必填**）
   
   - **描述**：知识库文件的路径。
   - **用途**：提供一个包含常见问题和答案的知识库文件，用于丰富模型的参考信息。
   - **特殊值**：如果不需要加载知识库，可以将其设置为 `'0'`。
   - **示例**：`--kb_file /path/to/knowledge_base.csv` 或 `--kb_file 0`

7. **`--pdict`**（字符串，**必填**）
   
   - **描述**：Prompt 字典文件的路径，通常是一个 pickle 序列化的字典文件。
   - **用途**：存储不同错误类型对应的提示模板，程序根据错误类型从中提取相应的 Prompt。
   - **示例**：`--pdict /path/to/prompt_dict.pkl`

8. **`--ext`**（字符串，*可选*，默认值为 `''`）
   
   - **描述**：附加内容，可以是任何需要传递给模型的额外信息。
   - **用途**：在生成提示时，替换 Prompt 模板中的 `$ext` 占位符，添加自定义信息。
   - **示例**：`--ext "请特别注意握拍姿势"`

#### 使用示例

```bash
python 6_llm_ttcoach.py \
  --api_key your_api_key_here \
  --base_url api.example.com \
  --model gpt-4-turbo \
  --fpath /path/to/your/workfolder \
  --type 3 \
  --kb_file /path/to/knowledge_base.csv \
  --pdict /path/to/prompt_dict.pkl \
  --ext "其他信息"
```

#### 参数使用详情

- **`--api_key`**
  
  您从模型提供方获取的 API 密钥。此密钥用于验证您的身份和权限，确保您能够访问和调用模型服务。请务必妥善保管，避免泄露。

- **`--base_url`**
  
  模型 API 的基础 URL，指定程序应连接的服务器地址。通常由模型提供方提供，可能的格式如 `api.openai.com`。

- **`--model`**
  
  要使用的具体模型名称。不同的模型可能具有不同的功能和性能，如 `gpt-3.5-turbo`、`gpt-4-turbo` 等。请根据需求选择合适的模型。

- **`--fpath`**
  
  工作文件夹路径，包含程序运行所需的所有文件和图像。程序将在此目录中查找特定的图像文件，如：
  
  - `arm_vector.jpg`
  - `paddle.jpg`
  - `pptrace.jpg`
  - 其他根据错误类型需要的图像
  
  请确保这些文件存在于指定的目录中，并且文件名与程序中调用的名称一致。

- **`--type`**
  
  指定要分析的错误类型，取值为 1 到 8 的整数。每个数字对应一种特定的技术错误，程序将根据该类型调用对应的分析函数。

- **`--kb_file`**
  
  知识库文件的路径，通常是一个 CSV 文件，包含以下列：
  
  - `index`：问题的索引编号
  - `question`：常见问题
  - `answer`：对应的答案
  - `embedding`：问题的嵌入向量
  
  程序将加载此文件，并使用嵌入向量进行相似度计算，从而检索与当前分析相关的知识。如果不需要知识库，可将此参数设置为 `'0'`。

- **`--pdict`**
  
  Prompt 字典文件的路径，包含不同错误类型对应的提示模板。程序使用 `pickle` 库加载此文件，并根据 `--type` 参数提取相应的 Prompt，用于生成请求。

- **`--ext`**
  
  附加内容，可用于传递额外的信息或上下文，增强模型的理解。在 Prompt 模板中，`$ext` 将被替换为此参数的值。

#### 程序运行流程

1. **参数解析**：程序首先使用 `argparse` 模块解析命令行参数，获取运行所需的配置信息。

2. **加载 Prompt 字典**：使用 `pickle` 库从 `--pdict` 指定的文件中加载 Prompt 模板数据。

3. **知识库加载与处理（可选）**：
   
   - 如果提供了 `--kb_file`，程序将加载知识库文件，并提取嵌入向量。
   - 使用模型生成当前输入的嵌入向量，与知识库中的向量进行相似度计算，检索最相关的问答对。

4. **图像编码**：
   
   - 根据 `--fpath` 指定的目录，加载所需的图像文件。
   - 使用 `base64` 编码将图像转换为字符串形式，准备发送给模型。

5. **错误分析**：
   
   - 根据 `--type` 指定的错误类型，调用对应的错误分析函数（`get_error_1` 到 `get_error_8`）。
   - 函数将组装请求消息，包括文本内容和图像数据。

6. **与模型通信**：
   
   - 使用 `http.client` 模块建立 HTTPS 连接，向模型 API 发送请求。
   - 请求包含模型名称、温度、消息内容、最大令牌数等参数。

7. **结果处理**：
   
   - 接收模型的响应，解析并提取生成的内容。
   - 输出模型的分析结果和建议。
